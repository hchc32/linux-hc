# lock
## 1.RAII

+ c语言下信号量和锁的使用，可以自己创建和释放，但是在C++中，这些资源都是private的,也就是说在我们无法保证对象被析构的时候,这些资源也会被删除，所以我们需要吧ctor和dtor与资源绑定起来．
+ RAII的核心思想就是将资源或者状态与对象的生命周期绑定，通过c++的语言机制，实现资源和状态的安全管理.

## 2.锁机制的功能

+ 实现多线程同步,通过锁机制，确保任意时刻只有一个线程能进入关键代码段.

> linux下提供三种加锁机制：
>
> + 信号量
> + 互斥锁
> + 条件变量(一般与互斥锁一起使用)

将以上三种都封装成各自的类，就可以实现了RAII机制.

# threadpool

## 1.服务器编程基本框架

![640](/home/hchc/Desktop/Note/640.webp)

主要由Ｉ/O单元，逻辑单元和网络存储单元组成．每个单元之间通过请求队列来进行通信，从而协同完成任务.

+ Ｉ/O单元用来处理客户端连接，读写网络数据.

+ 逻辑单元用于处理业务逻辑的线程.
+ 网络存储单元指的是本地数据库和文件等.

## 2.五种I/O模型

### 2.1阻塞i/o

调用函数的地方,如果该函数一直不反回，就一直等待函数返回，只有函数返回了，才进行下一步动作.

### 2.2非阻塞i/o

每隔一段事件就去检测i/o事件是否就绪，没有就绪就立即返回．

### 2.3信号驱动i/o

暂时接触不到

### 2.4i/o复用

linux用select/poll函数实现i/o复用模型，这两个函数会使得进程阻塞，但是和阻塞i/o不同，这两个函数可以同时阻塞多个i/o操作，而且可以同时对多个读操作，写操作的i/o函数进行检测,知道有数据可读或可写时,才真正调用i/o操作函数．

### 2.5异步i/o

上面四种都是同步i/o,同步i/o指内核向应用程序通知的是就绪事件(读就绪或者写就绪),异步i/o指内核向应用程序通知的是完成事件,读写i/0由内核完成.

## 3.事件处理模式

### 3.1reactor(反应堆)同步i/o)

> 主线程(i/o处理单元)只负责监听fd是否有事件发生,有的话立即通知工作线程(逻辑单元)，读写数据，接收新连接以及处理客户请求均在工作线程(逻辑单元)中完成.通常用同步io实现.

### 3.2proactor(异步i/o)

> 主线程和内核负责处理读写数据，接收新连接等i/o操作,工作线程仅负责业务逻辑的处理,如处理客户端请求.通常用异步i/o实现

##　4.线程池分析

### 4.1线程池设计模式

> 线程池的设计模式为半同步/半反应堆,其中反应堆具体为Proactor事件处理模式.

#### 什么是半同步/半反应堆？

+ 主线程充当异步线程，用来监听所有socket上的事件.
+ 若有新请求到来,主线程接收到新的socket连接,然后往epoll内核事件表中注册新的读写事件.
+ 如果连接socket上有读写事件发生,主线程从socket上接收数据,并将其封装成请求对象，插入请求队列中.
+ 所有工作线程睡眠在请求队列上,当有任务到来时,通过竞争来获取任务的接管权力.

#### 什么是半同步/半异步模式？

+ 同步线程处理客户逻辑
+ 异步线程用来处理i/o事件
+ 异步线程监听到客户请求后，就将请求封装起来，并插入请求队列中.
+ 请求队列将通知某个工作在同步模式下的工作线程来读取并处理该请求.



> 主线程为异步线程,负责监听文件描述符,接收socket连接，如果当前监听的socket发生了读写事件,然后将任务插入到请求队列中,工作线程从请求队列中取出任务,完成数据读写的处理.

### 4.2线程池的好处

+ 空间换时间
+ 线程池在服务器启动之前就完全被创建好并且初始化,这是静态资源.
+ 当服务器进入运行阶段,开始处理客户请求的时候,需要资源可以直接从池里面拿,不需要动态分配了.
+ 当服务器处理完一个客户连接后，可以把相关的资源放回池中，不需要执行系统调用来释放资源.



## HTTP协议

#### http请求报文

1.请求报文由**请求行**，**请求头部**，**空行**和**请求数据**四部分组成.

```c++
 GET /562f25980001b1b106000338.jpg HTTP/1.1(请求行)
 Host:img.mukewang.com　　　　　　　　　　　　　(请求头)
 User-Agent:Mozilla/5.0 (Windows NT 10.0; WOW64)
 AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.106   	Safari/537.36
 Accept:image/webp,image/*,*/*;q=0.8
 Referer:http://www.imooc.com/
 Accept-Encoding:gzip, deflate, sdch
 Accept-Language:zh-CN,zh;q=0.8
 空行
请求数据为空
```

从状态机负责读取报文的一行，主状态机负责对该行数据进行解析.

> 　主状态机内部调用从状态机，从状态机驱动主状态机

HTTP响应也由四个部分组成，分别是：状态行、消息报头、空行和响应正文。

#### http连接处理类

> http连接处理类:
>
> + 处理客户端发出的http请求,读写数据,报文解析
> + 内部存在一个主从状态机:从状态机用来读取每一行数据,从而驱动主状态机解析各部分数据(请求行,请求头部,空行,消息体(POST)).



















